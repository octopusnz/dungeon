<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><title>Dungeon (Browser)</title><meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
/* Shared base layout */
body{margin:0;line-height:1.25}
main{padding:10px;max-width:1200px;margin:0 auto}
.row{display:flex;flex-wrap:wrap;gap:10px}
.col{flex:1 1 320px;min-width:300px}
button{cursor:pointer}
/* BBS Theme */
body.theme-bbs{background:#000;font-family:'Source Code Pro','Courier New',monospace;color:#b4f5b4;font-size:15px}
body.theme-bbs header{background:#001900;color:#6bff6b;padding:6px 10px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #064f06}
body.theme-bbs h1{font-size:16px;font-weight:600;margin:0;letter-spacing:1px}
body.theme-bbs section.panel{background:#000;border:1px solid #1f5d1f;padding:6px 8px;margin:0 0 10px 0;position:relative}
body.theme-bbs section.panel:before{content:'+' attr(data-title) '---------------------------------------------';display:block;white-space:nowrap;overflow:hidden;color:#4cff4c;margin-bottom:4px;font-weight:600}
body.theme-bbs section.panel h2{display:none}
body.theme-bbs button{background:#000;border:1px solid #1f5d1f;color:#8dff8d;font-size:13px;padding:4px 8px;font-family:inherit;letter-spacing:.5px;text-transform:uppercase}
body.theme-bbs button:hover{background:#022d02}
body.theme-bbs button.danger{border-color:#5d1f1f;color:#ff8d8d}
body.theme-bbs button.danger:hover{background:#2d0202}
body.theme-bbs input[type=checkbox]{accent-color:#35c735}
body.theme-bbs #inventoryItems span{display:inline-block;border:1px solid #1f5d1f;padding:1px 4px;margin:2px 3px;font-size:11px;background:#001100;color:#9dff9d}
body.theme-bbs .luck-flag{margin-top:6px;font-size:12px;font-weight:600;letter-spacing:.5px}
body.theme-bbs .luck-ready{color:#6bff6b}
body.theme-bbs .luck-empty{color:#444}
body.theme-bbs #log{background:#000;border:1px solid #1f5d1f;padding:6px;font-size:12px;max-height:340px;overflow:auto;white-space:pre-wrap;line-height:1.2}
body.theme-bbs .muted{color:#4ca64c;font-size:12px;margin:4px 0 2px 0}
body.theme-bbs .currency{font-size:12px;font-weight:600;margin-top:4px;color:#7bff7b}
body.theme-bbs table.shop{width:100%;border-collapse:collapse;font-size:12px;margin-top:4px}
body.theme-bbs table.shop th,body.theme-bbs table.shop td{border:1px solid #1f5d1f;padding:3px 4px;text-align:left}
body.theme-bbs table.shop tbody tr:hover{background:#002400}
body.theme-bbs .tag{display:inline-block;padding:1px 4px;border:1px solid #1f5d1f;font-size:10px;letter-spacing:.5px;background:#001d00;color:#6bff6b}
body.theme-bbs label.inline{display:inline-flex;align-items:center;gap:4px;font-size:11px;margin-right:8px}
body.theme-bbs .actions-grid{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
body.theme-bbs #scene-panel{display:none}
body.theme-bbs .blink{animation:blink 1.1s steps(2,start) infinite}
@keyframes blink{to{visibility:hidden}}
body.theme-bbs .rar-Common{color:#b4f5b4}body.theme-bbs .rar-Uncommon{color:#6bff6b}body.theme-bbs .rar-Rare{color:#4cb7ff}body.theme-bbs .rar-Epic{color:#d18bff}body.theme-bbs .rar-Legendary{color:#ffcf5c}
body.theme-bbs .actions-grid.head{gap:6px}
/* Fantasy Theme */
@import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Cinzel:wght@400;600&family=Cormorant+Garamond:wght@400;500;600&display=swap');
body.theme-fantasy{font-family:'Cormorant Garamond','Fanwood Text',serif;font-size:18px;background:radial-gradient(circle at 25% 18%,rgba(110,84,42,0.15),transparent 60%),radial-gradient(circle at 82% 72%,rgba(140,95,40,0.12),transparent 70%),linear-gradient(#14181e,#0c0f14 70%);color:#ebe3d5}
body.theme-fantasy header{background:linear-gradient(90deg,#1b222a,#222a33 55%,#1b222a);border-bottom:2px solid #242e37;box-shadow:0 2px 6px rgba(0,0,0,.4);padding:1rem 1.25rem;display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
body.theme-fantasy h1{font-family:'Cinzel Decorative',cursive;font-size:1.7rem;letter-spacing:.55px;margin:0;text-shadow:0 0 6px rgba(255,220,140,.25)}
body.theme-fantasy section.panel{background:linear-gradient(145deg,rgba(60,46,34,0.92),rgba(30,22,18,0.92));border:1px solid #3a2f24;border-radius:14px;box-shadow:0 4px 10px rgba(0,0,0,.45),inset 0 0 0 1px rgba(255,255,255,0.04);padding:.9rem 1.05rem;margin:0 0 1rem 0;position:relative}
body.theme-fantasy section.panel:before{display:none}
body.theme-fantasy section.panel h2{display:flex;font:600 1.05rem 'Cinzel',serif;color:#caa75b;margin:0 0 .55rem 0;align-items:center}
body.theme-fantasy button{background:linear-gradient(145deg,#3f2e21,#2a2019);color:#f5e9d6;border:1px solid #4e3a2b;border-radius:8px;font:600 .85rem 'Cinzel',serif;letter-spacing:.55px;padding:.55rem .95rem}
body.theme-fantasy button:hover{background:linear-gradient(145deg,#57402d,#3a2b22)}
body.theme-fantasy button.danger{background:linear-gradient(145deg,#5e2323,#401515);border-color:#6d2c2c}
body.theme-fantasy button.danger:hover{background:linear-gradient(145deg,#7b2f2f,#512020)}
body.theme-fantasy #inventoryItems span{display:inline-block;background:linear-gradient(145deg,#3a2b22,#281f18);border:1px solid #4e3a2b;border-radius:6px;font-size:.72rem;letter-spacing:.42px;margin:2px 4px;padding:2px 6px}
body.theme-fantasy .luck-flag{margin-top:.35rem;font:600 .7rem 'Cinzel',serif;letter-spacing:.5px}
body.theme-fantasy .luck-ready{color:#e2c379;text-shadow:0 0 4px rgba(255,215,140,.4)}
body.theme-fantasy .luck-empty{color:#6d6257;opacity:.65}
body.theme-fantasy #log{background:#121517;border:1px solid #313a42;border-radius:10px;padding:.7rem .75rem;font-size:.72rem;max-height:320px;line-height:1.35;white-space:pre-wrap;overflow:auto}
body.theme-fantasy .muted{color:#b7c3cf;font-size:.75rem;margin:.3rem 0}
body.theme-fantasy .currency{font:600 .8rem 'Cinzel',serif;color:#d3b375;margin-top:.45rem}
body.theme-fantasy table.shop{width:100%;border-collapse:collapse;font-size:.7rem}
body.theme-fantasy table.shop th,body.theme-fantasy table.shop td{padding:4px 6px;border-bottom:1px solid #26303a;text-align:left}
body.theme-fantasy table.shop tbody tr:hover{background:#1f2831}
body.theme-fantasy .tag{font-family:'Cinzel',serif;font-size:.62rem;padding:3px 8px;border-radius:6px;min-width:54px;text-align:center;display:inline-block}
body.theme-fantasy .rar-Common{background:#55606b;color:#d2d8dd}
body.theme-fantasy .rar-Uncommon{background:#2d6d39;color:#cfe9d2}
body.theme-fantasy .rar-Rare{background:#1d4d8d;color:#c7ddff}
body.theme-fantasy .rar-Epic{background:#6a2f82;color:#f1d4ff}
body.theme-fantasy .rar-Legendary{background:#b07219;color:#ffe9c5}
body.theme-fantasy .actions-grid{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.4rem}
body.theme-fantasy label.inline{display:inline-flex;align-items:center;gap:.4rem;font-size:.65rem;margin-right:.75rem}
body.theme-fantasy #scene-panel{display:flex;justify-content:center;align-items:center;min-height:180px;overflow:hidden;padding:.5rem 0 .2rem 0}
body.theme-fantasy #scene-panel img{max-width:100%;height:auto;filter:drop-shadow(0 0 6px rgba(0,0,0,.6))}
body.theme-fantasy .blink{display:none}
/* Theme toggle button subtle variation */
#theme-toggle{margin-left:.75rem}
</style>
</style></head><body>
<header>
	<h1 id="title">= DUNGEON // BBS MODE =</h1>
	<div class="actions-grid head">
		<button id="act-shop-gen">NEW SHOP</button>
		<button id="act-reset" class="danger">RESET</button>
		<button id="theme-toggle" title="Toggle Theme">THEME</button>
	</div>
</header>
<main>
		<section class="panel" id="scene-panel" data-title=" SCENE ">
			<h2>Scene</h2>
			<img id="scene-img" src="assets/scene_pickpocket.svg" alt="Scene"/>
		</section>
		<section class="panel" id="inv-panel" data-title=" INVENTORY ">
			<h2>Inventory</h2>
			<div id="inventoryItems"></div>
			<div class="currency" id="inv-currency"></div>
			<div id="luck-status" class="luck-flag luck-empty">Luck: NONE</div>
			<div class="muted" id="luck-ind"></div>
		</section>
	<div class="row">
		<div class="col">
			<section class="panel" data-title=" PICKPOCKET ">
				<h2>Pickpocket</h2>
				<div class="muted" id="pp-info">Random loot candidates each attempt. Stored luck may trigger a special event.</div>
				<button id="pp-run">PICKPOCKET</button>
			</section>
			<section class="panel" id="fight-panel" data-title=" FIGHT ">
				<h2>Fight</h2>
				<div class="muted">Engage a random foe. Victory grants gold; defeat may cost some.</div>
				<button id="fight-run" style="margin-top:6px">FIGHT MONSTER</button>
			</section>
			<section class="panel" id="tavern-panel" data-title=" TAVERN ">
				<h2>Tavern</h2>
				<div class="muted">Spend coin for modest benefits; chance to gain stored luck.</div>
				<div class="actions-grid">
					<button data-tv="drink">DRINK</button>
					<button data-tv="food">FOOD</button>
					<button data-tv="stay">STAY</button>
					<button data-tv="tip">TIP</button>
					<button data-tv="flirt">FLIRT</button>
				</div>
			</section>
		</div>
		<div class="col">
			<section class="panel" id="shop-panel" data-title=" SHOP ">
				<h2>Shop</h2>
				<div id="shop-empty" class="muted">No shop. Press NEW SHOP.</div>
				<div id="shop-container" style="display:none">
					<table class="shop"><thead><tr><th></th><th>ITEM</th><th>RARITY</th><th>CP</th></tr></thead><tbody id="shop-body"></tbody></table>
					<div class="actions-grid">
						<label class="inline"><input type="checkbox" id="shop-haggle"/> HAGGLE</label>
						<label class="inline"><input type="checkbox" id="shop-use-luck"/> SPEND LUCK</label>
						<button id="shop-buy">BUY</button>
					</div>
				</div>
			</section>
		</div>
		<div class="col">
			<section class="panel" data-title=" LOG ">
				<h2>Log</h2>
				<div id="log"></div>
				<div class="muted blink">_</div>
			</section>
		</div>
	</div>
</main>
<script type="module">
import init, { Game } from './pkg/dungeon_core.js';
const el = id=>document.getElementById(id);
const logEl = el('log');
let game; let currentShop = [];
function log(msg){ const ts=new Date().toLocaleTimeString(); logEl.textContent += `[${ts}] ${msg}\n`; logEl.scrollTop = logEl.scrollHeight; }
function renderState(state){
	const invSpan = el('inventoryItems'); invSpan.innerHTML='';
	state.items.forEach(i=>{ const s=document.createElement('span'); s.textContent=i; invSpan.appendChild(s); });
	el('inv-currency').textContent = `GP ${state.gp} | SP ${state.sp} | CP ${state.cp}`;
	const luckFlag = el('luck-status');
	if(luckFlag){
		if(state.luck){
			luckFlag.textContent = 'Luck: READY';
			luckFlag.classList.remove('luck-empty');
			luckFlag.classList.add('luck-ready');
		}else{
			luckFlag.textContent = 'Luck: NONE';
			luckFlag.classList.remove('luck-ready');
			luckFlag.classList.add('luck-empty');
		}
	}
	el('luck-ind').textContent = state.luck ? 'Luck stored for next relevant action.' : '';
}
function unwrap(result){
	// Result may be either a WasmResult { state, message } or a raw WasmInventory
	if(!result) return;
	if(result.state){
		renderState(result.state);
		if(result.message) log(result.message);
		updateSceneFromMessage(result.message || '');
	} else {
		renderState(result);
	}
}
function activeTheme(){ return document.body.classList.contains('theme-fantasy') ? 'fantasy':'bbs'; }
function setScene(name){
	if(activeTheme()!=='fantasy') return; // only show in fantasy theme
	const img = document.getElementById('scene-img');
	if(img) img.src = `assets/scene_${name}.svg`;
}
function updateSceneFromMessage(msg){
	if(activeTheme()!=='fantasy') return;
	const m = (msg||'').toLowerCase();
	if(m.includes('victory')||m.includes('defeated')||m.includes('battle')||m.includes('fight')) setScene('fight');
	else if(m.includes('tavern')||m.includes('drink')||m.includes('meal')||m.includes('tip')||m.includes('kiss')) setScene('tavern');
	else if(m.includes('pickpocket')||m.includes('mysterious')) setScene('pickpocket');
}
function applyTheme(t){
	document.body.classList.remove('theme-bbs','theme-fantasy');
	document.body.classList.add(t==='fantasy'?'theme-fantasy':'theme-bbs');
	const title = el('title');
	if(title){ title.textContent = t==='fantasy' ? 'Dungeon (Fantasy)' : '= DUNGEON // BBS MODE ='; }
	// Scene panel visibility handled via CSS; force initial image if switching to fantasy
	if(t==='fantasy') setScene('pickpocket');
	localStorage.setItem('dungeon_theme', t);
}
function toggleTheme(){ applyTheme(activeTheme()==='fantasy'?'bbs':'fantasy'); }
async function start(){
	await init();
	game = new Game();
	unwrap(game.get_state());
	log('Game started');
	const saved = localStorage.getItem('dungeon_theme');
	applyTheme(saved==='fantasy'?'fantasy':'bbs');
}
start();
// Core actions
el('act-reset').onclick=()=>unwrap(game.reset());
el('pp-run').onclick=()=>{ unwrap(game.pickpocket("")); };
// Fight panel
el('fight-run').onclick=()=>{ unwrap(game.fight()); };
// Shop
el('act-shop-gen').onclick=()=>{ const res=game.generate_shop(); currentShop = res.items; buildShop(); log('Generated new shop stock'); };
function buildShop(){ const empty=el('shop-empty'); const cont=el('shop-container'); const body=el('shop-body'); if(!currentShop||!currentShop.length){ empty.style.display=''; cont.style.display='none'; return;} empty.style.display='none'; cont.style.display=''; body.innerHTML=''; currentShop.forEach(it=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><input type='checkbox' data-id='${it.id}'></td><td>${it.name}</td><td><span class='tag rar-${it.rarity}'>${it.rarity}</span></td><td>${it.price_cp}</td>`; body.appendChild(tr); }); }
el('shop-buy').onclick=()=>{ const checks=[...document.querySelectorAll('#shop-body input[type=checkbox]:checked')]; if(!checks.length){ log('No items selected'); return; } const ids=checks.map(c=>Number(c.getAttribute('data-id'))); const haggle=el('shop-haggle').checked; const spend=el('shop-use-luck').checked; unwrap(game.shop_purchase(ids, haggle, spend)); };
// Tavern buttons
document.querySelectorAll('#tavern-panel button[data-tv]').forEach(b=>{ b.onclick=()=>{ const act=b.getAttribute('data-tv'); unwrap(game.tavern(act)); }; });
// Theme toggle
el('theme-toggle').onclick=toggleTheme;
</script>
</body></html>
